function [y1,xf1] = myNeuralNetworkFunction(x1,xi1)
%MYNEURALNETWORKFUNCTION neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 23-Apr-2017 14:41:47.
%
% [y1,xf1] = myNeuralNetworkFunction(x1,xi1) takes these arguments:
%   x1 = 15xTS matrix, input #1
%   xi1 = 15x1 matrix, initial 1 delay states for input #1.
% and returns:
%   y1 = 15xTS matrix, output #1
%   xf1 = 15x1 matrix, final 1 delay states for input #1.
% where TS is the number of timesteps.

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.keep = [1 2 3 4 5 6 7 8 9 10 11 12 13 14];
x1_step2.xoffset = [-12.1212528153389;-0.509297276176125;-1.86603492175087;-0.425156868499801;-1.10653510119823;-2.02220135257141;-0.663146056976838;-0.689119497499751;-0.556342458665701;-1.34611510118562;-1.804194293311;-0.403488965236868;-1.38905342551488;-0.871324923469097];
x1_step2.gain = [0.0175140332386346;0.0244916786433017;0.0183704836616459;0.0203346180960638;0.0199285338238563;0.0212685923641224;0.0208088097086062;0.022653592241502;0.021046907577446;0.0273951396530895;0.0232428684701665;0.0239043944374459;0.0206040129548129;0.0226730979558537];
x1_step2.ymin = -1;

% Layer 1
b1 = [-0.27876890220314726188;0.087982048447152697013;-0.38626943224126147891;0.11006333319676121774;-0.077680292197103636975;0.14700282958471122541;-0.17183219129251861568;-0.18286461295310552089];
IW1_1 = [0.35038019328469666158 -0.27023924848503494411 -0.24647472344229526264 0.2024995402487902163 0.10044310687372735857 -0.60397328248574833065 -0.39309029967941866435 0.57559349477291088526 -0.39701882488712858521 0.21702252513639855303 0.39063418093546437015 0.054624196632756000236 0.2775126170007438664 -0.022616458524062847679;0.107872214517147888 -0.22400488214934663467 -0.90616171751635909981 -0.44138370980322250148 0.31902918894467785504 -0.10981626947722374077 -0.094761899425884144055 0.063779201761407181004 0.29365790988834933328 -0.38966546131467028058 -0.19488839168542890223 0.42380427064838277484 0.026415465850998721964 -0.059159195253973222151;0.39419962911064232447 0.72946248555593229401 0.10446001727891943145 -0.1807384066340413098 0.22521635018287061714 -0.13219966979395281204 -0.25055397599213047322 -0.092244347585949001966 0.6844350335908070404 -0.42998840064679000328 -0.23604994823699781969 -0.069156755499442237878 -0.13654970005476563255 0.040882433855004368661;-0.13628821510693220342 0.016125665859880043002 -0.042451547851451040816 0.37434229072003011307 0.92089603285383903053 -0.081250884297609904383 -0.016763142654453087182 -0.10593352086698305803 0.076479029956068034224 0.14375264858589870132 -0.18203407953322969792 -0.36971144667795780014 -0.17411090298528106302 -0.0048708245248697892849;-0.11793447483010645327 -0.7306163067343740547 0.13146452773287040094 0.27512014553427360797 0.11672250013924177769 0.39123925539697063103 0.19589349204632916512 0.0097361907530656641163 -0.14334067856352109005 -0.52262368657267321836 -0.49030056476367767093 -0.70867762924710642203 0.32387325020349411187 -0.063533833106304907212;0.12584855148675228032 0.02292405267010051706 -0.013070132751736717944 -0.18001016249489390497 -0.20120682341993506581 -0.28840535760890451122 0.055830734220480543462 0.064770747701526784623 -0.3152646751696222549 -0.082941708774477096444 0.013174707464101311979 -0.25050558526614774557 0.53685110408269176574 0.77709253463391270156;0.45252331469899542693 -0.14779075918463163708 0.47621707960187220632 0.066845682762871949656 0.023537870689074150837 0.45879660017769163805 -0.46349999002540004378 0.061196356642919773339 -0.29599166203761728688 -0.58421384855071289977 0.27661116481648567733 0.021947435875823914642 0.0096023620072819265009 -0.074366268731216586541;0.12485671672026435464 -0.51130700313731680673 -0.14242387720944899021 0.11010082361060041789 -0.41392954130820952541 -0.27827241848074346642 -0.030088807555203694183 -0.45332646384167629705 -0.29041838942148756608 -0.15301680915992280085 0.014921183751156221614 -0.36283982679069060051 -0.60336040747311592281 0.22074500434021715467];

% Layer 2
b2 = [0.27248213102472013114;-0.076761407672354037279;0.1654480637703737711;0.13082173970281124609;-0.2016555044868719726;-0.28233451277091126119;-0.21759978967746151923;-0.42962996466308195354;-0.002891712824010203662;-0.081145958820771829645;-0.30543271591256038189;0.064054154414489694602;-0.0095748523458754532939;-0.098341674473098203424];
LW2_1 = [-0.16543565064675860854 -0.15127951763622751735 0.61072064500258271824 -0.047823191695351888186 -0.40048742307189433287 0.18741606142763975185 0.47344530857044803129 -0.078623897162914582748;-0.011619432832034029199 -0.77359374447932383045 0.34529284944761040599 -0.0016270713055658203756 -0.11327855793370043835 0.10398479281948640185 -0.12050737445581266583 -0.34484795600278550509;0.31750989782024086061 -0.91495922631041570749 -0.071126515384048502599 0.2216294543048176191 0.086334620066927603155 -0.063477932969034353561 0.1082239234017744467 -0.113896469523960292;0.18387035337725338158 -0.035852610361998493715 -0.09376152640331172905 0.81643530461368785112 -0.0089819121234082800048 -0.28227564843027419528 0.23143483544269116692 -0.1617600485658449716;-0.27694127407873997404 0.005223501495867807938 -0.016892785737591318324 0.82934437422652784733 0.079767690944223368366 -0.048350733725563511956 -0.04074850496766741631 0.077727912752071831592;-0.79346886769114177707 -0.12970593481215189624 -0.2218032063923714714 -0.25377344783014721408 0.69457848209631023462 -0.12163431131153558395 0.15779809605038369602 -0.11056130285946932923;0.39642539875017129836 -0.037725130108295097664 -0.080438040561846016474 -0.32636546145315353806 0.95435987707291347615 -0.28957806306333738755 -0.70157731679140766801 0.34586829715831829413;-0.33039196169553769478 0.35948158479396019604 -0.11534069522358580961 -0.36180575258454894527 0.052215936011058575184 -0.4069364027632589309 0.097875305513096005905 0.042224098191860320872;-0.34811910987653393867 -0.051277101733810281914 -0.00733635525432155787 0.1222582322870004734 -0.46569463834103969058 0.083306541729284269704 -1.0587597889164890308 -0.2783758973209824461;0.09328055630692523581 -0.31805161282068866724 -0.85780540246167835683 -0.076669299099513379958 -0.57669565929502963897 -0.34328131274476147983 0.027713667120912572478 0.16227646219563671148;0.43887062941178645037 0.79434472342913697851 -0.19072312936702043307 0.62373219293402071273 -0.17962441849933921678 0.044395285802420934862 0.1039172689015547546 -0.29013179960602647478;0.35608698406802502534 -0.092710692276457493111 -0.53542792438192154947 -0.50299573937890540432 -0.015309189364360814914 0.22581129306722175221 0.38529526987971024488 -0.74425221173202060765;0.058455972095177465009 0.026262436049841055008 -0.10423620978488840061 0.13765755278055083477 0.061095382459529251618 1.1676828560453831329 0.031461242077535124528 -0.14870857753995081474;-0.40451265807837155641 -0.26042973541917247005 0.31351229954942133604 -0.43911278335776793291 -0.50696109932384270103 0.19357525122607407986 0.40282285278918417148 0.59202341965302851534];

% Output 1
y1_step2.ymin = -1;
y1_step2.gain = [0.0175140332386346;0.0244916786433017;0.0183704836616459;0.0203346180960638;0.0199285338238563;0.0212685923641224;0.0208088097086062;0.022653592241502;0.021046907577446;0.0273951396530895;0.0232428684701665;0.0239043944374459;0.0206040129548129;0.0226730979558537];
y1_step2.xoffset = [-12.1212528153389;-0.509297276176125;-1.86603492175087;-0.425156868499801;-1.10653510119823;-2.02220135257141;-0.663146056976838;-0.689119497499751;-0.556342458665701;-1.34611510118562;-1.804194293311;-0.403488965236868;-1.38905342551488;-0.871324923469097];
y1_step1.xrows = 15;
y1_step1.keep = [1 2 3 4 5 6 7 8 9 10 11 12 13 14];
y1_step1.remove = 15;
y1_step1.constants = 0;

% ===== SIMULATION ========

% Dimensions
TS = size(x1,2); % timesteps

% Input 1 Delay States
xd1 = removeconstantrows_apply(xi1,x1_step1);
xd1 = mapminmax_apply(xd1,x1_step2);
xd1 = [xd1 zeros(14,1)];

% Allocate Outputs
y1 = zeros(15,TS);

% Time loop
for ts=1:TS
    
    % Rotating delay state position
    xdts = mod(ts+0,2)+1;
    
    % Input 1
    temp = removeconstantrows_apply(x1(:,ts),x1_step1);
    xd1(:,xdts) = mapminmax_apply(temp,x1_step2);
    
    % Layer 1
    tapdelay1 = reshape(xd1(:,mod(xdts-1-1,2)+1),14,1);
    a1 = tansig_apply(b1 + IW1_1*tapdelay1);
    
    % Layer 2
    a2 = b2 + LW2_1*a1;
    
    % Output 1
    temp = mapminmax_reverse(a2,y1_step2);
    y1(:,ts) = removeconstantrows_reverse(temp,y1_step1);
end

% Final delay states
finalxts = TS+(1: 1);
xits = finalxts(finalxts<=1);
xts = finalxts(finalxts>1)-1;
xf1 = [xi1(:,xits) x1(:,xts)];
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
y = bsxfun(@minus,x,settings.xoffset);
y = bsxfun(@times,y,settings.gain);
y = bsxfun(@plus,y,settings.ymin);
end

% Remove Constants Input Processing Function
function y = removeconstantrows_apply(x,settings)
y = x(settings.keep,:);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
x = bsxfun(@minus,y,settings.ymin);
x = bsxfun(@rdivide,x,settings.gain);
x = bsxfun(@plus,x,settings.xoffset);
end

% Remove Constants Output Reverse-Processing Function
function x = removeconstantrows_reverse(y,settings)
Q = size(y,2);
x = nan(settings.xrows,Q,'like',y);
x(settings.keep,:) = y;
x(settings.remove,:) = repmat(settings.constants,1,Q);
end
